<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shared Expense Tracker (Firebase + Google Login)</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111;
      --muted: #666;
      --card: #fff;
      --border: #ddd;
      --thead: #f2f2f2;
      --warnBg: #fff8e1;
      --warnBorder: #ffe0b2;
      --warnText: #5d4303;
      --err: #b00020;
    }
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); }
    h1 { margin: 0 0 12px 0; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
    .auth { display:flex; align-items:center; gap:8px; }
    .muted { color:var(--muted); font-size:12px; }
    form { display: flex; gap: 10px; flex-wrap: wrap; margin: 12px 0 20px; }
    input, button { padding: 8px; }
    table { width: 100%; border-collapse: collapse; background: var(--card); }
    th, td { padding: 8px; border: 1px solid var(--border); text-align: left; }
    th { background: var(--thead); }
    a { color: blue; }
    .hidden { display:none; }
    .thumb { width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid var(--border); }
    .error { color:var(--err); font-size:12px; margin:6px 0; }
    .note { color:var(--warnText); background:var(--warnBg); border:1px solid var(--warnBorder); padding:6px 8px; border-radius:6px; font-size:12px; }
    .section-title { margin: 22px 0 8px; font-size: 18px; }
    .toolbar { display:flex; align-items:center; gap:10px; margin:10px 0 20px; }
  </style>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- XLSX for Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="topbar">
    <h1>💸 Shared Expense Tracker</h1>
    <div class="auth">
      <span id="userInfo" class="muted hidden"></span>
      <button id="signInBtn">Sign in with Google</button>
      <button id="signOutBtn" class="hidden">Sign out</button>
    </div>
  </div>

  <div id="authError" class="error"></div>
  <div id="signedOutMsg" class="muted">Please sign in to view and edit shared expenses.</div>

  <div id="app" class="hidden">
    <form id="entryForm">
      <div id="uploadStatus" class="muted"></div>
      <input id="person" name="person" placeholder="Person" required />
      <input id="amount" name="amount" type="number" step="0.01" placeholder="Amount" required />
      <input id="date" name="date" type="date" required />
      <input id="note" name="note" placeholder="Note" />
      <input id="image" name="image" type="file" accept="image/*" />
      <button type="submit">Add</button>
    </form>

    <div id="fallbackNotice" class="note hidden">
      Network blocked uploads to Firebase Storage. I saved the image inside Firestore instead. Everything will still display normally.
    </div>

    <div class="section-title">Expenses</div>
    <table>
      <thead>
        <tr>
          <th>Receipt</th>
          <th>Person</th>
          <th>Amount</th>
          <th>Note</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="section-title">Tools</div>
    <div class="toolbar">
      <button id="exportBtn" type="button">Export to Excel</button>
      <button id="importBtn" type="button">Import from Excel</button>
      <input id="importFile" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
      <span id="importStatus" class="muted"></span>
    </div>
  </div>

  <script>
    // === Your Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyAPICqhLo25TvAQnCHZiZWDO6qyBA_CLXo",
      authDomain: "sharedexpenses-2510b.firebaseapp.com",
      projectId: "sharedexpenses-2510b",
      storageBucket: "sharedexpenses-2510b.appspot.com",
      messagingSenderId: "312950592413",
      appId: "1:312950592413:web:62239b41780211ba31d574"
    };

    // Init Firebase services
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    storage.setMaxUploadRetryTime(45000);
    storage.setMaxOperationRetryTime(45000);

    const expensesRef = db.collection("expenses");

    // UI refs
    const app = document.getElementById('app');
    const signedOutMsg = document.getElementById('signedOutMsg');
    const userInfo = document.getElementById('userInfo');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const authError = document.getElementById('authError');
    const tbody = document.getElementById('tbody');
    const entryForm = document.getElementById('entryForm');
    const dateInput = document.getElementById('date');
    const uploadStatus = document.getElementById('uploadStatus');
    const fallbackNotice = document.getElementById('fallbackNotice');

    // Import/Export refs
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const importStatus = document.getElementById('importStatus');

    let entries = [];
    let unsubscribe = null;

    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function todayStr(){ return new Date().toISOString().slice(0,10); }
    dateInput.value = todayStr();

    // --- Auth (popup with redirect fallback)
    const provider = new firebase.auth.GoogleAuthProvider();
    async function signInWithGoogle() {
      try { await auth.signInWithPopup(provider); }
      catch (err) { await auth.signInWithRedirect(provider); }
    }

    signInBtn.addEventListener('click', async ()=>{
      authError.textContent = '';
      try { await signInWithGoogle(); }
      catch(e){ authError.textContent = 'Sign-in error: ' + (e?.message||e); }
    });

    signOutBtn.addEventListener('click', async ()=>{
      authError.textContent = '';
      try { await auth.signOut(); }
      catch(e){ authError.textContent = 'Sign-out error: ' + (e?.message||e); }
    });

    auth.getRedirectResult().catch(e=>{
      authError.textContent = 'Sign-in error: ' + (e?.message || e);
    });

    function setFormEnabled(enabled){
      entryForm.querySelectorAll('input,button').forEach(el => el.disabled = !enabled);
    }

    auth.onAuthStateChanged(user=>{
      if(user){
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        userInfo.textContent = `Signed in as ${user.displayName || user.email}`;
        userInfo.classList.remove('hidden');
        signedOutMsg.classList.add('hidden');
        app.classList.remove('hidden');
        setFormEnabled(true);

        if (unsubscribe) unsubscribe();
        unsubscribe = expensesRef.orderBy("date","desc").onSnapshot(
          snap=>{ entries = []; snap.forEach(doc => entries.push(doc.data())); render(); },
          err=>{ console.error(err); authError.textContent = 'Read error (Firestore rules/domain?): ' + (err?.message || err); }
        );
      } else {
        if (unsubscribe) unsubscribe();
        entries = []; render();
        userInfo.classList.add('hidden');
        signOutBtn.classList.add('hidden');
        signInBtn.classList.remove('hidden');
        signedOutMsg.classList.remove('hidden');
        app.classList.add('hidden');
        setFormEnabled(false);
      }
    });

    // === Image helpers ===
    async function compressImage(file, maxDim = 1280, quality = 0.8) { // Return { blob, contentType }
      return new Promise((resolve) => {
        const originalType = file.type || 'application/octet-stream';
        const reader = new FileReader();
        const img = new Image();
        const fallback = () => resolve({ blob: file, contentType: originalType });
        reader.onerror = fallback;
        img.onerror = fallback;
        reader.onload = () => { img.src = reader.result; };
        img.onload = () => {
          let { width, height } = img;
          if (width > height && width > maxDim) { height = Math.round(height * (maxDim / width)); width = maxDim; }
          else if (height >= width && height > maxDim) { width = Math.round(width * (maxDim / height)); height = maxDim; }
          const canvas = document.createElement('canvas');
          canvas.width = width; canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob((blob) => { if (blob) resolve({ blob, contentType: 'image/jpeg' }); else fallback(); }, 'image/jpeg', quality);
        };
        reader.readAsDataURL(file);
      });
    }

    function blobToDataURL(blob){
      return new Promise((res, rej) => { const r = new FileReader(); r.onerror = rej; r.onload = () => res(r.result); r.readAsDataURL(blob); });
    }

    // Try Storage upload; if network blocks Storage, fall back to inline data URL
    async function uploadImageSmart(file) {
      uploadStatus.textContent = 'Preparing image…';
      const { blob, contentType } = await compressImage(file);
      let ext = 'jpg';
      if (contentType !== 'image/jpeg') {
        const m = (file.name || '').match(/\.(\w+)$/);
        ext = m ? m[1].toLowerCase() : 'bin';
      }
      const baseName = (file.name || 'receipt').replace(/[^a-z0-9._-]/gi,'_');
      const safeName = `${Date.now()}-${baseName}.${ext}`;
      const ref = storage.ref(`receipts/${safeName}`);
      const metadata = { contentType };

      try {
        await new Promise((resolve, reject) => {
          const task = ref.put(blob, metadata);
          task.on('state_changed', (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            uploadStatus.textContent = `Uploading… ${pct}%`;
          }, (err) => reject(err), () => resolve());
        });
        const url = await ref.getDownloadURL();
        uploadStatus.textContent = '';
        fallbackNotice.classList.add('hidden');
        return { url, inline: false };
      } catch (err) {
        const msg = (err && err.message) ? err.message : String(err);
        if (msg.includes('retry-limit-exceeded') || msg.includes('network') || msg.includes('Failed to fetch')) {
          const dataUrl = await blobToDataURL(blob);
          uploadStatus.textContent = '';
          fallbackNotice.classList.remove('hidden');
          return { url: dataUrl, inline: true };
        }
        uploadStatus.textContent = '';
        throw err;
      }
    }

    // --- Create entry
    entryForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      authError.textContent = '';
      const user = auth.currentUser;
      if(!user){ authError.textContent = 'Please sign in first.'; return; }

      const fd = new FormData(ev.target);
      const person = (fd.get('person')||'').toString().trim();
      const amount = Number(fd.get('amount')||0);
      const note = (fd.get('note')||'').toString();
      const date = (fd.get('date')||todayStr()).toString();

      let imageURL = null;
      const file = fd.get('image');
      const submitBtn = entryForm.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      try {
        if (file && file.size) {
          const res = await uploadImageSmart(file);
          imageURL = res.url;
        }
        const now = firebase.firestore.FieldValue.serverTimestamp();
        const entry = { id: uid(), person, amount, note, date, image: imageURL,
                        uid: user.uid, email: user.email, displayName: user.displayName || '',
                        createdAt: now, updatedAt: now };
        await expensesRef.doc(entry.id).set(entry);
        ev.target.reset();
        dateInput.value = todayStr();
        uploadStatus.textContent = '';
        submitBtn.disabled = false;
      } catch (e) {
        console.error(e);
        const msg = e && e.message ? e.message : String(e);
        if (msg.includes('permission') || msg.includes('storage/unauthorized')) {
          authError.textContent = 'Upload blocked by Storage rules. Ensure rules allow request.auth != null and you are signed in.';
        } else if (msg.includes('No default bucket') || msg.includes('storage bucket')) {
          authError.textContent = 'Storage bucket not initialized. Firebase Console → Build → Storage → “Get started”.';
        } else {
          authError.textContent = 'Image upload failed: ' + msg;
        }
        uploadStatus.textContent = '';
        submitBtn.disabled = false;
      }
    });

    // --- Row actions (delete only)
    tbody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if (action === 'delete') {
        try {
          if (confirm('Delete this entry?')) {
            await expensesRef.doc(id).delete();
          }
        } catch (e) {
          console.error(e);
          authError.textContent = 'Delete error: ' + (e?.message || e);
        }
      }
    });

    // --- Import / Export (Excel)
    function exportToExcel(){
      try {
        const data = entries.map(e => ({
          Person: e.person || '',
          Amount: Number(e.amount || 0),
          Note: e.note || '',
          Date: e.date || '',
          ReceiptURL: e.image || '',
          EntryID: e.id || '',
          CreatedBy: e.displayName || e.email || ''
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
        XLSX.writeFile(wb, 'expenses_' + (new Date().toISOString().slice(0,10)) + '.xlsx');
      } catch (e) {
        console.error(e);
        authError.textContent = 'Export failed: ' + (e?.message || e);
      }
    }

    function normalizeDateForInput(val){
      try {
        if (!val && val !== 0) return '';
        if (val instanceof Date) {
          const y = val.getFullYear();
          const m = String(val.getMonth()+1).padStart(2,'0');
          const d = String(val.getDate()).padStart(2,'0');
          return `${y}-${m}-${d}`;
        }
        if (typeof val === 'number' && XLSX?.SSF?.parse_date_code) {
          const o = XLSX.SSF.parse_date_code(val);
          if (o) return `${o.y}-${String(o.m).padStart(2,'0')}-${String(o.d).padStart(2,'0')}`;
        }
        const s = String(val).trim();
        const dt = new Date(s);
        if (!isNaN(dt)) {
          const y = dt.getFullYear();
          const m = String(dt.getMonth()+1).padStart(2,'0');
          const d = String(dt.getDate()).padStart(2,'0');
          return `${y}-${m}-${d}`;
        }
        return s;
      } catch { return ''; }
    }

    async function handleImport(ev){
      importStatus.textContent = '';
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      try {
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array', cellDates:true });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval:'', raw:true });
        if (!rows.length) { importStatus.textContent = 'No rows found.'; return; }

        let batch = db.batch(); let ops = 0; let added = 0;
        const flush = async () => { if (ops>0) { await batch.commit(); batch = db.batch(); ops = 0; } };

        for (const r of rows) {
          const mapKey = k => String(k||'').toLowerCase().trim();
          const get = (names) => {
            for (const n of names) {
              if (Object.prototype.hasOwnProperty.call(r, n)) return r[n];
              for (const key in r) { if (mapKey(key) === mapKey(n)) return r[key]; }
            }
            return '';
          };

          const person = String(get(['Person','Name'])).trim();
          const amountVal = get(['Amount']);
          const amount = Number(typeof amountVal === 'string' ? amountVal.replace(/[^0-9.\-]/g,'') : amountVal) || 0;
          let date = get(['Date']);
          const note = String(get(['Note','Notes'])).trim();
          const image = String(get(['ReceiptURL','Image'])).trim() || null;
          const idFromSheet = String(get(['EntryID','ID'])).trim();

          if (!person || !amount) continue;

          date = normalizeDateForInput(date) || todayStr();

          const now = firebase.firestore.FieldValue.serverTimestamp();
          const id = idFromSheet || uid();
          const docRef = expensesRef.doc(id);
          batch.set(docRef, {
            id, person, amount, note, date, image,
            uid: auth.currentUser?.uid || '',
            email: auth.currentUser?.email || '',
            displayName: auth.currentUser?.displayName || '',
            updatedAt: now,
            createdAt: now
          }, { merge: true });
          ops++; added++;
          if (ops >= 400) { await flush(); } // stay under 500 writes/batch
        }
        await flush();
        importStatus.textContent = 'Imported ' + added + ' row(s).';
        importFile.value = '';
      } catch (e) {
        console.error(e);
        importStatus.textContent = 'Import failed: ' + (e?.message || e);
      }
    }

    if (exportBtn) exportBtn.addEventListener('click', exportToExcel);
    if (importBtn) importBtn.addEventListener('click', ()=> importFile && importFile.click());
    if (importFile) importFile.addEventListener('change', handleImport);

    // --- Renderers
    function render() {
      tbody.innerHTML = entries.map(e => `
        <tr>
          <td>${e.image ? `<a href="${escapeAttr(e.image)}" target="_blank"><img class="thumb" src="${escapeAttr(e.image)}" alt="receipt"></a>` : '—'}</td>
          <td>${escapeHtml(e.person)}</td>
          <td>${Number(e.amount||0).toFixed(2)}</td>
          <td>${escapeHtml(e.note||'')}</td>
          <td>${escapeHtml(e.date||'')}</td>
          <td><button data-action="delete" data-id="${e.id}">Delete</button></td>
        </tr>
      `).join('');
    }

    // --- Utils
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }
    function escapeAttr(s){ return String(s).replace(/"/g, '&quot;'); }
  </script>
</body>
</html>
