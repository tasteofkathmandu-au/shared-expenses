<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shared Expense Tracker (Firebase + Google Login)</title>
  <style>
    :root{
      --panel:#ffffff; --muted:#6b7280; --text:#111827; --accent:#2563eb; --danger:#ef4444; --border:#e5e7eb; --radius:14px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; color:var(--text); background:#fff; }
    .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 48px}
    header.topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:14px; }
    .brand{ font-weight:800; letter-spacing:.3px; font-size:20px }
    .auth{ display:flex; align-items:center; gap:8px }
    .muted{ color:var(--muted); font-size:12px }
    button{ appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer }
    .btn{ background:#f3f4f6; color:var(--text); border:1px solid var(--border); }
    .btn-primary{ background:linear-gradient(90deg, #60a5fa, #3b82f6); color:#0b1020 }
    .btn-danger{ background:linear-gradient(90deg, #fca5a5, #ef4444); color:#fff }
    .btn-ghost{ background:transparent; color:var(--text); border:1px solid var(--border) }
    .stack{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow: 0 2px 14px rgba(0,0,0,.04); }
    .card .body{ padding:16px }

    form.grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px }
    .col-12{ grid-column: span 12 }
    @media(min-width:760px){ .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-5{grid-column:span 5} .col-6{grid-column:span 6} }

    input[type="text"], input[type="number"], input[type="date"], input[type="file"]{
      width:100%; background:#fff; color:var(--text); border:1px solid #d1d5db; border-radius:12px; padding:10px 12px; outline:none;
    }
    input::file-selector-button{ background:#f3f4f6; color:var(--text); border:1px solid var(--border); padding:8px 10px; border-radius:10px; margin-right:8px }

    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:760px; background:#fff; border-radius:12px; overflow:hidden; border:1px solid var(--border) }
    thead th{ position:sticky; top:0; background:#f9fafb; text-align:left; font-size:12px; color:#374151; padding:12px; border-bottom:1px solid var(--border) }
    tbody td{ padding:12px; border-top:1px solid var(--border); vertical-align:top; color:#111827 }
    .thumb{ width:56px; height:56px; object-fit:cover; border-radius:10px; border:1px solid var(--border) }

    .error{ color:#b91c1c; font-size:12px; margin:6px 0 }
    .note{ color:#1f2937; background:#fef3c7; border:1px solid #fde68a; padding:8px 10px; border-radius:10px; font-size:12px }
    .hidden{ display:none }
  </style>

  <!-- Firebase SDKs (compat) -->
  <!-- If your network blocks gstatic, host these locally and update the src paths -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <main class="wrap">
    <header class="topbar">
      <div class="brand">ðŸ’¸ Shared Expense Tracker</div>
      <div class="stack">
        <button id="exportBtn" class="btn">Export Excel</button>
        <span id="userInfo" class="muted hidden"></span>
        <button id="signInBtn" class="btn-primary">Sign in with Google</button>
        <button id="signOutBtn" class="btn hidden">Sign out</button>
      </div>
    </header>

    <div id="authError" class="error"></div>
    <div id="signedOutMsg" class="muted">Please sign in to view and edit shared expenses.</div>

    <section id="app" class="hidden card">
      <div class="body">
        <form id="entryForm" class="grid">
          <div class="col-12 muted" id="uploadStatus"></div>
          <div class="col-4"><input id="person" name="person" placeholder="Person" required type="text" /></div>
          <div class="col-3"><input id="amount" name="amount" type="number" step="0.01" placeholder="Amount" required /></div>
          <div class="col-3"><input id="date" name="date" type="date" required /></div>
          <div class="col-12"><input id="note" name="note" placeholder="Note" type="text" /></div>
          <div class="col-6"><input id="image" name="image" type="file" accept="image/*" /></div>
          <div class="col-6 stack" style="justify-content:flex-end">
            <label id="removeImageWrap" class="hidden"><input type="checkbox" id="removeImageChk" /> Remove image</label>
            <button type="button" id="cancelEditBtn" class="btn hidden">Cancel</button>
            <button type="submit" id="submitBtn" class="btn-primary">Add</button>
          </div>
        </form>

        <div id="fallbackNotice" class="note hidden">Network blocked Firebase Storage. Saved image inside Firestore (base64). Very large photos may be rejected.</div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="body" style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Receipt</th>
              <th>Person</th>
              <th>Amount</th>
              <th>Note</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="stack" style="margin-top:12px; justify-content:space-between">
          <div class="muted">Tip: click a thumbnail to open full image.</div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="body" style="overflow:auto">
        <div class="stack" style="justify-content:space-between">
          <div class="brand" style="font-size:16px">History</div>
          <div class="muted">Recent activity</div>
        </div>
        <table>
          <thead>
            <tr>
              <th>When</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </section>
  </main>

<script>
  // === Firebase Config ===
  const firebaseConfig = {
    apiKey: "AIzaSyAPICqhLo25TvAQnCHZiZWDO6qyBA_CLXo",
    authDomain: "sharedexpenses-2510b.firebaseapp.com",
    projectId: "sharedexpenses-2510b",
    storageBucket: "sharedexpenses-2510b.appspot.com",
    messagingSenderId: "312950592413",
    appId: "1:312950592413:web:62239b41780211ba31d574"
  };

  // Init Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();
  storage.setMaxUploadRetryTime(20000);
  storage.setMaxOperationRetryTime(20000);

  const expensesRef = db.collection("expenses");
  const activityRef = db.collection("activity");

  // UI refs
  const app = document.getElementById('app');
  const signedOutMsg = document.getElementById('signedOutMsg');
  const userInfo = document.getElementById('userInfo');
  const signInBtn = document.getElementById('signInBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const authError = document.getElementById('authError');
  const tbody = document.getElementById('tbody');
  const historyBody = document.getElementById('historyBody');
  const entryForm = document.getElementById('entryForm');
  const dateInput = document.getElementById('date');
  const uploadStatus = document.getElementById('uploadStatus');
  const fallbackNotice = document.getElementById('fallbackNotice');
  const exportBtn = document.getElementById('exportBtn');
  const submitBtn = document.getElementById('submitBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const removeImageWrap = document.getElementById('removeImageWrap');
  const removeImageChk = document.getElementById('removeImageChk');

  let entries = [];
  let activity = [];
  let unsubExpenses = null;
  let unsubActivity = null;
  let editingId = null; // if set, we're editing this doc

  function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
  function todayStr(){ return new Date().toISOString().slice(0,10); }
  dateInput.value = todayStr();

  // --- Auth
  const provider = new firebase.auth.GoogleAuthProvider();
  async function signInWithGoogle() { try { await auth.signInWithPopup(provider); } catch (err) { await auth.signInWithRedirect(provider); } }
  signInBtn.addEventListener('click', async ()=>{ authError.textContent = ''; try { await signInWithGoogle(); } catch(e){ authError.textContent = 'Sign-in error: ' + (e?.message||e); }});
  signOutBtn.addEventListener('click', async ()=>{ authError.textContent = ''; try { await auth.signOut(); } catch(e){ authError.textContent = 'Sign-out error: ' + (e?.message||e); }});
  auth.getRedirectResult().catch(e=>{ authError.textContent = 'Sign-in error: ' + (e?.message || e); });

  function setFormEnabled(enabled){ entryForm.querySelectorAll('input,button').forEach(el => el.disabled = !enabled); }

  auth.onAuthStateChanged(user=>{
    if(user){
      signInBtn.classList.add('hidden');
      signOutBtn.classList.remove('hidden');
      userInfo.textContent = `Signed in as ${user.displayName || user.email}`;
      userInfo.classList.remove('hidden');
      signedOutMsg.classList.add('hidden');
      app.classList.remove('hidden');
      setFormEnabled(true);

      if (unsubExpenses) unsubExpenses();
      unsubExpenses = expensesRef.orderBy("date","desc").onSnapshot(
        snap=>{ entries = []; snap.forEach(doc => entries.push(doc.data())); render(); },
        err=>{ console.error(err); authError.textContent = 'Read error (Firestore rules/domain?): ' + (err?.message || err); }
      );

      if (unsubActivity) unsubActivity();
      unsubActivity = activityRef.orderBy("at","desc").limit(100).onSnapshot(
        snap=>{ activity = []; snap.forEach(doc => activity.push(doc.data())); renderHistory(); },
        err=>{ console.error(err); }
      );
    }else{
      if (unsubExpenses) unsubExpenses();
      if (unsubActivity) unsubActivity();
      entries = []; activity = []; render(); renderHistory();
      userInfo.classList.add('hidden');
      signOutBtn.classList.add('hidden');
      signInBtn.classList.remove('hidden');
      signedOutMsg.classList.remove('hidden');
      app.classList.add('hidden');
      setFormEnabled(false);
    }
  });

  // === Image helpers (inline fallback) ===
  async function compressImageCapped(file, maxDimStart = 1280, targetBytes = 650 * 1024) {
    const dimOptions = [maxDimStart, 1100, 1000, 900, 800];
    const qualityOptions = [0.8, 0.7, 0.6, 0.5, 0.4];
    function drawAndBlob(img, w, h, q){ return new Promise((res)=>{ const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); c.toBlob(b=>res(b),'image/jpeg',q); }); }
    function loadImage(file){ return new Promise((res,rej)=>{ const r=new FileReader(), img=new Image(); r.onerror=()=>rej(new Error('read-failed')); img.onerror=()=>rej(new Error('image-failed')); r.onload=()=>{ img.src=r.result; }; img.onload=()=>res(img); r.readAsDataURL(file); }); }
    try{
      const img = await loadImage(file);
      for (const dim of dimOptions){
        let {width,height} = img;
        if (width > height && width > dim){ height = Math.round(height * (dim/width)); width = dim; }
        else if (height >= width && height > dim){ width = Math.round(width * (dim/height)); height = dim; }
        for (const q of qualityOptions){
          const blob = await drawAndBlob(img,width,height,q);
          if (blob && blob.size <= targetBytes) return { blob, contentType:'image/jpeg' };
        }
      }
    }catch(_){ }
    return { blob:file, contentType:file.type || 'application/octet-stream' };
  }
  function blobToDataURL(blob){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=rej; r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }
  async function uploadViaFirebase(blob, filename, contentType){
    const ref = storage.ref(`receipts/${filename}`);
    const metadata = { contentType };
    return new Promise((resolve, reject) => {
      const task = ref.put(blob, metadata);
      task.on('state_changed', (snap)=>{
        const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
        uploadStatus.textContent = `Uploadingâ€¦ ${pct}%`;
      }, reject, async ()=>{ const url = await ref.getDownloadURL(); resolve(url); });
    });
  }
  async function uploadImageSmart(file){
    uploadStatus.textContent = 'Preparing imageâ€¦';
    const { blob, contentType } = await compressImageCapped(file);
    if (blob.size > 650 * 1024){ uploadStatus.textContent=''; throw new Error('Selected image is still too large after compression. Please choose a smaller image.'); }
    const baseName = (file.name || 'receipt').replace(/[^a-z0-9._-]/gi,'_');
    const filename = `${Date.now()}-${baseName}`.replace(/\.+/g,'.');
    try{
      const url = await uploadViaFirebase(blob, filename, contentType);
      uploadStatus.textContent = ''; fallbackNotice.classList.add('hidden'); return url;
    }catch(e){
      const msg = (e && e.message) ? e.message : String(e);
      if (msg.includes('retry-limit-exceeded') || msg.toLowerCase().includes('network') || msg.includes('Failed to fetch')){
        const dataUrl = await blobToDataURL(blob);
        uploadStatus.textContent = ''; fallbackNotice.classList.remove('hidden'); return dataUrl;
      }
      uploadStatus.textContent = ''; throw e;
    }
  }

  // --- Activity logger
  function diffFields(before={}, after={}){
    const keys = ['person','amount','note','date','image'];
    const changed=[]; keys.forEach(k=>{ if (String(before[k]??'') !== String(after[k]??'')) changed.push(k); });
    return changed;
  }
  async function logActivity({action, expenseId, before=null, after=null, user}){
    const now = firebase.firestore.FieldValue.serverTimestamp();
    const changed = diffFields(before||{}, after||{});
    const base = {
      id: uid(), expenseId, action,
      person: (after?.person â ?? before?.person) || '',
      amount: Number(after?.amount â ?? before?.amount â ?? 0),
      note: (after?.note â ?? before?.note) || '',
      date: (after?.date â ?? before?.date) || '',
      byUid: user.uid, byEmail: user.email, byName: user.displayName || '',
      at: now, changed
    };
    await activityRef.doc(base.id).set(base);
  }

  // --- Add / Edit entry
  entryForm.addEventListener('submit', async (ev)=>{
    ev.preventDefault(); authError.textContent='';
    const user = auth.currentUser; if (!user){ authError.textContent='Please sign in first.'; return; }
    const fd = new FormData(ev.target);
    const person = (fd.get('person')||'').toString().trim();
    const amount = Number(fd.get('amount')||0);
    const note = (fd.get('note')||'').toString();
    const date = (fd.get('date')||todayStr()).toString();
    const file = fd.get('image');

    submitBtn.disabled = true;
    try{
      if (!editingId){
        // CREATE
        let imageURL=null; if (file && file.size) imageURL = await uploadImageSmart(file);
        const now = firebase.firestore.FieldValue.serverTimestamp();
        const id = uid();
        const after = { id, person, amount, note, date, image:imageURL, uid:user.uid, email:user.email, displayName:user.displayName||'', createdAt:now, updatedAt:now };
        await expensesRef.doc(id).set(after);
        await logActivity({ action:'create', expenseId:id, before:null, after, user });
      } else {
        // UPDATE
        const now = firebase.firestore.FieldValue.serverTimestamp();
        const before = entries.find(e=>e.id===editingId) || {};
        let imageURL = before.image || null;
        if (removeImageChk.checked) imageURL = null; // explicit remove
        if (file && file.size) imageURL = await uploadImageSmart(file); // replace
        const after = { person, amount, note, date, image:imageURL, updatedAt:now };
        await expensesRef.doc(editingId).set(after, { merge:true });
        await logActivity({ action:'update', expenseId:editingId, before, after, user });
      }
      // reset UI
      entryForm.reset(); dateInput.value = todayStr();
      endEditMode();
    }catch(e){
      console.error(e);
      const msg = e && e.message ? e.message : String(e);
      if (msg.includes('permission') || msg.includes('storage/unauthorized')) authError.textContent = 'Upload blocked by Storage rules. Ensure rules allow request.auth != null and you are signed in.';
      else authError.textContent = 'Save error: ' + msg;
    } finally { uploadStatus.textContent=''; submitBtn.disabled=false; }
  });

  // --- Table actions (Edit/Delete)
  tbody.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
    if (action==='delete'){
      try{
        const user = auth.currentUser; if (!user){ authError.textContent='Please sign in first.'; return; }
        const before = entries.find(e=>e.id===id) || {};
        await logActivity({ action:'delete', expenseId:id, before, after:null, user });
        await expensesRef.doc(id).delete();
      }
      catch(e){ console.error(e); authError.textContent = 'Delete error: ' + (e?.message||e); }
    }
    if (action==='edit'){
      const e = entries.find(x=>x.id===id); if(!e) return;
      editingId = id;
      document.getElementById('person').value = e.person || '';
      document.getElementById('amount').value = Number(e.amount||0);
      document.getElementById('date').value = e.date || todayStr();
      document.getElementById('note').value = e.note || '';
      removeImageChk.checked = false;
      beginEditMode();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  function beginEditMode(){ submitBtn.textContent='Update'; cancelEditBtn.classList.remove('hidden'); removeImageWrap.classList.remove('hidden'); }
  function endEditMode(){ editingId=null; submitBtn.textContent='Add'; cancelEditBtn.classList.add('hidden'); removeImageWrap.classList.add('hidden'); removeImageChk.checked=false; }
  cancelEditBtn.addEventListener('click', ()=>{ entryForm.reset(); dateInput.value=todayStr(); endEditMode(); });

  // --- Render table
  function render(){
    tbody.innerHTML = entries.map(e=>`
      <tr>
        <td>${e.image ? `<a href="${e.image}" target="_blank" rel="noopener"><img class="thumb" src="${e.image}" alt="receipt"></a>` : 'â€”'}</td>
        <td>${escapeHtml(e.person)}</td>
        <td>${Number(e.amount||0).toFixed(2)}</td>
        <td>${escapeHtml(e.note||'')}</td>
        <td>${escapeHtml(e.date||'')}</td>
        <td class="stack"><button class="btn" data-action="edit" data-id="${e.id}">Edit</button><button class="btn-danger" data-action="delete" data-id="${e.id}">Delete</button></td>
      </tr>
    `).join('');
  }

  function fmtDateTime(ts){ try{ if(!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }catch{ return ''; } }
  function renderHistory(){
    historyBody.innerHTML = activity.map(a=>`
      <tr>
        <td>${fmtDateTime(a.at)}</td>
        <td>${escapeHtml(a.action)}</td>
      </tr>
    `).join('');
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  // --- Excel Export
  function exportToExcel(){
    try{
      if (typeof XLSX === 'undefined') { alert('Excel library failed to load.'); return; }
      const rows = entries.map(e=>({ id:e.id, person:e.person, amount:Number(e.amount||0), note:e.note||'', date:e.date||'', image:e.image||'' }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
      XLSX.writeFile(wb, `expenses-${new Date().toISOString().slice(0,10)}.xlsx`);
    }catch(err){ console.error(err); alert('Export failed: '+(err?.message||err)); }
  }
  exportBtn.addEventListener('click', exportToExcel);
</script>
</body>
</html>
